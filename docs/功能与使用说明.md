# 项目功能与使用说明

## 工具概述
`k8s-daily-summary` 是一个使用 TypeScript 开发的 CLI 工具，负责连接 Kubernetes 集群、抓取关键运行数据，并以多种格式输出日常健康报告。核心流程如下：

1. 通过命令行参数确定时间范围、命名空间和输出格式。
2. 利用 `@kubernetes/client-node` 建立到集群的连接，读取 Pod、Job 与 Event 信息。
3. 汇总出集群在指定时间窗口内的运行状况，并生成可读性强的洞察内容。

## 功能清单
- **Pod 健康洞察**：统计总 Pod 数量、阶段分布，列出发生重启、处于异常状态或失败的 Pod，并追踪重启次数、原因、最近一次重启时间等细节。
- **批处理工作负载分析**：统计成功、失败、仍在运行的 Job；为失败 Job 给出执行时长和失败原因，帮助快速定位问题。
- **事件聚合与告警**：收集 Warning 级别的 Kubernetes 事件，按原因聚合并展示出现次数、涉及对象和最近发生时间，同时记录总事件数量。
- **智能提示**：根据汇总结果自动输出关键洞察，例如 OOMKilled、CrashLoopBackOff 等典型告警，或提示失败的 Pod 与 Job 数量。
- **多格式输出**：支持终端彩色表格（console）、JSON、Markdown 以及 HTML 格式，便于在不同场景（巡检、自动化集成、汇报）下使用。
- **文件落盘**：通过 `--output` 指定路径，可把报告保存为文件（目录不存在时会自动创建）。
- **自定义 kubeconfig**：通过 `--kubeconfig` 指定凭据文件，或使用默认路径自动加载。

## 安装与准备
1. 确保本地具备 Node.js 16+ 与 npm。
2. 拥有可访问的 Kubernetes 集群和对应 `kubeconfig` 权限。
3. 安装依赖并构建项目：
   ```bash
   npm install
   npm run build
   ```

## 基本使用
```bash
# 以开发模式执行，默认统计过去 24 小时的所有命名空间
npm run dev

# 使用已编译版本
node dist/index.js

# 直接调用 CLI 名称（需全局安装或在 package.json 的 bin 环境下）
npx k8s-daily-summary
```

## 常用参数
| 参数 | 说明 | 默认值 |
|------|------|---------|
| `-h, --hours <number>` | 统计过去 N 小时数据（需为正整数） | 24 |
| `-n, --namespace <string>` | 仅关注指定命名空间 | 所有命名空间 |
| `-f, --format <format>` | 输出格式：`console`、`json`、`markdown`、`html` | `console` |
| `-o, --output <file>` | 把结果写入指定文件 | 不写文件，直接输出到终端 |
| `-k, --kubeconfig <path>` | 指定 kubeconfig 文件路径 | 使用默认 kubeconfig |

**示例命令**：
```bash
# 生成最近 12 小时的生产命名空间 Markdown 报告并写入文件
npm run dev -- --hours 12 --namespace production --format markdown --output reports/daily.md

# 统计最近 2 小时并以 HTML 格式保存
npm run dev -- --hours 2 --format html --output reports/last-2h.html

# 以 JSON 结构输出，可用于自动化脚本
npm run dev -- --format json | jq '.summary.pods.restarted | length'
```

## 输出内容说明
- **时间范围**：展示报告覆盖的开始与结束时间，以及分析所用的命名空间和窗口小时数。
- **Pod 区块**：包括总数、各阶段数量、重启列表、异常/失败列表及对应节点、原因和时间。
- **Job 区块**：列出成功、失败、活跃 Job 数并给出失败原因和耗时。
- **事件区块**：聚合 Warning 事件，列出出现次数、关联对象、最后出现时间，总结整体事件数量。
- **关键洞察**：自动生成的文字建议，例如存在 OOMKilled 或 CrashLoopBackOff、失败 Job 数量过多等。

HTML Formatter 额外提供推荐监控指标板块，提示与 Pod 稳定性、资源饱和度、可靠性和容量相关的观测项。

## 运行时行为
- 工具启动后会尝试列出命名空间以检测连通性，失败时立即退出并提示排查 kubeconfig 与集群状态。
- 若设置环境变量 `K8S_SUMMARY_SKIP_CONNECT=1`，程序会跳过连接集群的步骤（用于本地测试场景）。
- 数据采集采用并发 Promise，确保在较大集群下仍能快速完成统计。

## 项目结构速览
```
src/
  analyzers/summary.ts    # 汇总并生成报告所需的数据结构与洞察
  collectors/             # 对应 Kubernetes API 的数据抓取逻辑
    pod.ts                # Pod 重启、异常状态、阶段分布
    job.ts                # Job 成功/失败/活跃统计
    event.ts              # Warning 事件聚合
  formatters/             # console/markdown/html 等格式化输出
  utils/k8s-client.ts     # 基于 @kubernetes/client-node 的封装
```

## 推荐使用场景
- **每日巡检**：定时输出 Markdown 或 HTML 报告，快速掌握运行趋势。
- **突发事件排查**：缩短时间窗口并聚焦生产命名空间，定位重启/失败热点。
- **自动化集成**：以 JSON 输出配合脚本，作为 CI/CD 或监控探针的健康信号。

如需更多细节，可结合源代码中的 `SummaryAnalyzer`、`PodCollector` 等类了解实现方式。
